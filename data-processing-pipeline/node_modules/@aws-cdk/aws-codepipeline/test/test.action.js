"use strict";
// import { validateArtifactBounds, validateSourceAction } from '../lib/validation';
const assert_1 = require("@aws-cdk/assert");
const codebuild = require("@aws-cdk/aws-codebuild");
const codecommit = require("@aws-cdk/aws-codecommit");
const actions = require("@aws-cdk/aws-codepipeline-api");
const cdk = require("@aws-cdk/cdk");
const codepipeline = require("../lib");
// tslint:disable:object-literal-key-quotes
class TestAction extends actions.Action {
}
function boundsValidationResult(numberOfArtifacts, min, max) {
    const stack = new cdk.Stack();
    const pipeline = new codepipeline.Pipeline(stack, 'pipeline');
    const stage = new codepipeline.Stage(stack, 'stage', { pipeline });
    const action = new TestAction(stack, 'TestAction', {
        stage,
        artifactBounds: actions.defaultBounds(),
        category: actions.ActionCategory.Test,
        provider: 'test provider'
    });
    const artifacts = [];
    for (let i = 0; i < numberOfArtifacts; i++) {
        artifacts.push(new actions.Artifact(action, `TestArtifact${i}`));
    }
    return actions.validateArtifactBounds('output', artifacts, min, max, 'testCategory', 'testProvider');
}
module.exports = {
    'artifact bounds validation': {
        'artifacts count exceed maximum'(test) {
            const result = boundsValidationResult(1, 0, 0);
            test.deepEqual(result.length, 1);
            test.ok(result[0].match(/cannot have more than 0/), 'the validation should have failed');
            test.done();
        },
        'artifacts count below minimum'(test) {
            const result = boundsValidationResult(1, 2, 2);
            test.deepEqual(result.length, 1);
            test.ok(result[0].match(/must have at least 2/), 'the validation should have failed');
            test.done();
        },
        'artifacts count within bounds'(test) {
            const result = boundsValidationResult(1, 0, 2);
            test.deepEqual(result.length, 0);
            test.done();
        },
    },
    'action type validation': {
        'must be source and is source'(test) {
            const result = actions.validateSourceAction(true, actions.ActionCategory.Source, 'test action', 'test stage');
            test.deepEqual(result.length, 0);
            test.done();
        },
        'must be source and is not source'(test) {
            const result = actions.validateSourceAction(true, actions.ActionCategory.Deploy, 'test action', 'test stage');
            test.deepEqual(result.length, 1);
            test.ok(result[0].match(/may only contain Source actions/), 'the validation should have failed');
            test.done();
        },
        'cannot be source and is source'(test) {
            const result = actions.validateSourceAction(false, actions.ActionCategory.Source, 'test action', 'test stage');
            test.deepEqual(result.length, 1);
            test.ok(result[0].match(/may only occur in first stage/), 'the validation should have failed');
            test.done();
        },
        'cannot be source and is not source'(test) {
            const result = actions.validateSourceAction(false, actions.ActionCategory.Deploy, 'test action', 'test stage');
            test.deepEqual(result.length, 0);
            test.done();
        },
    },
    'automatically assigns artifact names to the Actions'(test) {
        const stack = new cdk.Stack();
        const pipeline = new codepipeline.Pipeline(stack, 'pipeline');
        const repo = new codecommit.Repository(stack, 'Repo', {
            repositoryName: 'Repo',
        });
        const sourceStage = pipeline.addStage('Source');
        repo.addToPipeline(sourceStage, 'CodeCommit');
        const project = new codebuild.PipelineProject(stack, 'Project');
        const buildStage = pipeline.addStage('Build');
        project.addToPipeline(buildStage, 'CodeBuild');
        assert_1.expect(stack).to(assert_1.haveResourceLike('AWS::CodePipeline::Pipeline', {
            "Stages": [
                {
                    "Name": "Source",
                    "Actions": [
                        {
                            "Name": "CodeCommit",
                            "InputArtifacts": [],
                            "OutputArtifacts": [
                                {
                                    "Name": "Artifact_RepoCodeCommit7910F5F9",
                                },
                            ],
                        }
                    ],
                },
                {
                    "Name": "Build",
                    "Actions": [
                        {
                            "Name": "CodeBuild",
                            "InputArtifacts": [
                                {
                                    "Name": "Artifact_RepoCodeCommit7910F5F9",
                                }
                            ],
                            "OutputArtifacts": [
                                {
                                    "Name": "Artifact_ProjectCodeBuildE34AD2EC",
                                },
                            ],
                        }
                    ],
                },
            ],
        }));
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5hY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LmFjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsb0ZBQW9GO0FBQ3BGLDRDQUEyRDtBQUMzRCxvREFBcUQ7QUFDckQsc0RBQXVEO0FBQ3ZELHlEQUEwRDtBQUMxRCxvQ0FBcUM7QUFFckMsdUNBQXdDO0FBRXhDLDJDQUEyQztBQUUzQyxNQUFNLFVBQVcsU0FBUSxPQUFPLENBQUMsTUFBTTtDQUFHO0FBOEcxQyxTQUFTLHNCQUFzQixDQUFDLGlCQUF5QixFQUFFLEdBQVcsRUFBRSxHQUFXO0lBQ2pGLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzlCLE1BQU0sUUFBUSxHQUFHLElBQUksWUFBWSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDOUQsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFZLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBQ25FLE1BQU0sTUFBTSxHQUFHLElBQUksVUFBVSxDQUFDLEtBQUssRUFBRSxZQUFZLEVBQUU7UUFDakQsS0FBSztRQUNMLGNBQWMsRUFBRSxPQUFPLENBQUMsYUFBYSxFQUFFO1FBQ3ZDLFFBQVEsRUFBRSxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUk7UUFDckMsUUFBUSxFQUFFLGVBQWU7S0FDMUIsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxTQUFTLEdBQXVCLEVBQUUsQ0FBQztJQUN6QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsaUJBQWlCLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDMUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQ2xFO0lBQ0Qs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O3dCQUNUOzRCQUNFLE1BQU0sRUFBRSxZQUFZOzRCQUNwQixnQkFBZ0IsRUFBRSxFQUFFOzRCQUNwQixpQkFBaUIsRUFBRTtnQ0FDakI7b0NBQ0UsTUFBTSxFQUFFLGlDQUFpQztpQ0FDMUM7NkJBQ0Y7eUJBQ0Y7cUJBQ0Y7aUJBQ0Y7Z0JBQ0Q7b0JBQ0UsTUFBTSxFQUFFLE9BQU87b0JBQ2YsU0FBUyxFQUFFO3dCQUNUOzRCQUNFLE1BQU0sRUFBRSxXQUFXOzRCQUNuQixnQkFBZ0IsRUFBRTtnQ0FDaEI7b0NBQ0UsTUFBTSxFQUFFLGlDQUFpQztpQ0FDMUM7NkJBQ0Y7NEJBQ0QsaUJBQWlCLEVBQUU7Z0NBQ2pCO29DQUNFLE1BQU0sRUFBRSxtQ0FBbUM7aUNBQzVDOzZCQUNGO3lCQUNGO3FCQUNGO2lCQUNGO2FBQ0Y7U0FDRixDQUFDLENBQUMsQ0FBQztRQUVKLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW1wb3J0IHsgdmFsaWRhdGVBcnRpZmFjdEJvdW5kcywgdmFsaWRhdGVTb3VyY2VBY3Rpb24gfSBmcm9tICcuLi9saWIvdmFsaWRhdGlvbic7XG5pbXBvcnQgeyBleHBlY3QsIGhhdmVSZXNvdXJjZUxpa2UgfSBmcm9tICdAYXdzLWNkay9hc3NlcnQnO1xuaW1wb3J0IGNvZGVidWlsZCA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1jb2RlYnVpbGQnKTtcbmltcG9ydCBjb2RlY29tbWl0ID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWNvZGVjb21taXQnKTtcbmltcG9ydCBhY3Rpb25zID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWNvZGVwaXBlbGluZS1hcGknKTtcbmltcG9ydCBjZGsgPSByZXF1aXJlKCdAYXdzLWNkay9jZGsnKTtcbmltcG9ydCB7IFRlc3QgfSBmcm9tICdub2RldW5pdCc7XG5pbXBvcnQgY29kZXBpcGVsaW5lID0gcmVxdWlyZSgnLi4vbGliJyk7XG5cbi8vIHRzbGludDpkaXNhYmxlOm9iamVjdC1saXRlcmFsLWtleS1xdW90ZXNcblxuY2xhc3MgVGVzdEFjdGlvbiBleHRlbmRzIGFjdGlvbnMuQWN0aW9uIHt9XG5cbmV4cG9ydCA9IHtcbiAgJ2FydGlmYWN0IGJvdW5kcyB2YWxpZGF0aW9uJzoge1xuXG4gICAgJ2FydGlmYWN0cyBjb3VudCBleGNlZWQgbWF4aW11bScodGVzdDogVGVzdCkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYm91bmRzVmFsaWRhdGlvblJlc3VsdCgxLCAwLCAwKTtcbiAgICAgIHRlc3QuZGVlcEVxdWFsKHJlc3VsdC5sZW5ndGgsIDEpO1xuICAgICAgdGVzdC5vayhyZXN1bHRbMF0ubWF0Y2goL2Nhbm5vdCBoYXZlIG1vcmUgdGhhbiAwLyksICd0aGUgdmFsaWRhdGlvbiBzaG91bGQgaGF2ZSBmYWlsZWQnKTtcbiAgICAgIHRlc3QuZG9uZSgpO1xuICAgIH0sXG5cbiAgICAnYXJ0aWZhY3RzIGNvdW50IGJlbG93IG1pbmltdW0nKHRlc3Q6IFRlc3QpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGJvdW5kc1ZhbGlkYXRpb25SZXN1bHQoMSwgMiwgMik7XG4gICAgICB0ZXN0LmRlZXBFcXVhbChyZXN1bHQubGVuZ3RoLCAxKTtcbiAgICAgIHRlc3Qub2socmVzdWx0WzBdLm1hdGNoKC9tdXN0IGhhdmUgYXQgbGVhc3QgMi8pLCAndGhlIHZhbGlkYXRpb24gc2hvdWxkIGhhdmUgZmFpbGVkJyk7XG4gICAgICB0ZXN0LmRvbmUoKTtcbiAgICB9LFxuXG4gICAgJ2FydGlmYWN0cyBjb3VudCB3aXRoaW4gYm91bmRzJyh0ZXN0OiBUZXN0KSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBib3VuZHNWYWxpZGF0aW9uUmVzdWx0KDEsIDAsIDIpO1xuICAgICAgdGVzdC5kZWVwRXF1YWwocmVzdWx0Lmxlbmd0aCwgMCk7XG4gICAgICB0ZXN0LmRvbmUoKTtcbiAgICB9LFxuICB9LFxuXG4gICdhY3Rpb24gdHlwZSB2YWxpZGF0aW9uJzoge1xuXG4gICAgJ211c3QgYmUgc291cmNlIGFuZCBpcyBzb3VyY2UnKHRlc3Q6IFRlc3QpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGFjdGlvbnMudmFsaWRhdGVTb3VyY2VBY3Rpb24odHJ1ZSwgYWN0aW9ucy5BY3Rpb25DYXRlZ29yeS5Tb3VyY2UsICd0ZXN0IGFjdGlvbicsICd0ZXN0IHN0YWdlJyk7XG4gICAgICB0ZXN0LmRlZXBFcXVhbChyZXN1bHQubGVuZ3RoLCAwKTtcbiAgICAgIHRlc3QuZG9uZSgpO1xuICAgIH0sXG5cbiAgICAnbXVzdCBiZSBzb3VyY2UgYW5kIGlzIG5vdCBzb3VyY2UnKHRlc3Q6IFRlc3QpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGFjdGlvbnMudmFsaWRhdGVTb3VyY2VBY3Rpb24odHJ1ZSwgYWN0aW9ucy5BY3Rpb25DYXRlZ29yeS5EZXBsb3ksICd0ZXN0IGFjdGlvbicsICd0ZXN0IHN0YWdlJyk7XG4gICAgICB0ZXN0LmRlZXBFcXVhbChyZXN1bHQubGVuZ3RoLCAxKTtcbiAgICAgIHRlc3Qub2socmVzdWx0WzBdLm1hdGNoKC9tYXkgb25seSBjb250YWluIFNvdXJjZSBhY3Rpb25zLyksICd0aGUgdmFsaWRhdGlvbiBzaG91bGQgaGF2ZSBmYWlsZWQnKTtcbiAgICAgIHRlc3QuZG9uZSgpO1xuICAgIH0sXG5cbiAgICAnY2Fubm90IGJlIHNvdXJjZSBhbmQgaXMgc291cmNlJyh0ZXN0OiBUZXN0KSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhY3Rpb25zLnZhbGlkYXRlU291cmNlQWN0aW9uKGZhbHNlLCBhY3Rpb25zLkFjdGlvbkNhdGVnb3J5LlNvdXJjZSwgJ3Rlc3QgYWN0aW9uJywgJ3Rlc3Qgc3RhZ2UnKTtcbiAgICAgIHRlc3QuZGVlcEVxdWFsKHJlc3VsdC5sZW5ndGgsIDEpO1xuICAgICAgdGVzdC5vayhyZXN1bHRbMF0ubWF0Y2goL21heSBvbmx5IG9jY3VyIGluIGZpcnN0IHN0YWdlLyksICd0aGUgdmFsaWRhdGlvbiBzaG91bGQgaGF2ZSBmYWlsZWQnKTtcbiAgICAgIHRlc3QuZG9uZSgpO1xuICAgIH0sXG5cbiAgICAnY2Fubm90IGJlIHNvdXJjZSBhbmQgaXMgbm90IHNvdXJjZScodGVzdDogVGVzdCkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYWN0aW9ucy52YWxpZGF0ZVNvdXJjZUFjdGlvbihmYWxzZSwgYWN0aW9ucy5BY3Rpb25DYXRlZ29yeS5EZXBsb3ksICd0ZXN0IGFjdGlvbicsICd0ZXN0IHN0YWdlJyk7XG4gICAgICB0ZXN0LmRlZXBFcXVhbChyZXN1bHQubGVuZ3RoLCAwKTtcbiAgICAgIHRlc3QuZG9uZSgpO1xuICAgIH0sXG4gIH0sXG5cbiAgJ2F1dG9tYXRpY2FsbHkgYXNzaWducyBhcnRpZmFjdCBuYW1lcyB0byB0aGUgQWN0aW9ucycodGVzdDogVGVzdCkge1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgIGNvbnN0IHBpcGVsaW5lID0gbmV3IGNvZGVwaXBlbGluZS5QaXBlbGluZShzdGFjaywgJ3BpcGVsaW5lJyk7XG5cbiAgICBjb25zdCByZXBvID0gbmV3IGNvZGVjb21taXQuUmVwb3NpdG9yeShzdGFjaywgJ1JlcG8nLCB7XG4gICAgICByZXBvc2l0b3J5TmFtZTogJ1JlcG8nLFxuICAgIH0pO1xuICAgIGNvbnN0IHNvdXJjZVN0YWdlID0gcGlwZWxpbmUuYWRkU3RhZ2UoJ1NvdXJjZScpO1xuICAgIHJlcG8uYWRkVG9QaXBlbGluZShzb3VyY2VTdGFnZSwgJ0NvZGVDb21taXQnKTtcblxuICAgIGNvbnN0IHByb2plY3QgPSBuZXcgY29kZWJ1aWxkLlBpcGVsaW5lUHJvamVjdChzdGFjaywgJ1Byb2plY3QnKTtcbiAgICBjb25zdCBidWlsZFN0YWdlID0gcGlwZWxpbmUuYWRkU3RhZ2UoJ0J1aWxkJyk7XG4gICAgcHJvamVjdC5hZGRUb1BpcGVsaW5lKGJ1aWxkU3RhZ2UsICdDb2RlQnVpbGQnKTtcblxuICAgIGV4cGVjdChzdGFjaykudG8oaGF2ZVJlc291cmNlTGlrZSgnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgICAgXCJTdGFnZXNcIjogW1xuICAgICAgICB7XG4gICAgICAgICAgXCJOYW1lXCI6IFwiU291cmNlXCIsXG4gICAgICAgICAgXCJBY3Rpb25zXCI6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgXCJOYW1lXCI6IFwiQ29kZUNvbW1pdFwiLFxuICAgICAgICAgICAgICBcIklucHV0QXJ0aWZhY3RzXCI6IFtdLFxuICAgICAgICAgICAgICBcIk91dHB1dEFydGlmYWN0c1wiOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgXCJOYW1lXCI6IFwiQXJ0aWZhY3RfUmVwb0NvZGVDb21taXQ3OTEwRjVGOVwiLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9XG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIFwiTmFtZVwiOiBcIkJ1aWxkXCIsXG4gICAgICAgICAgXCJBY3Rpb25zXCI6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgXCJOYW1lXCI6IFwiQ29kZUJ1aWxkXCIsXG4gICAgICAgICAgICAgIFwiSW5wdXRBcnRpZmFjdHNcIjogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIFwiTmFtZVwiOiBcIkFydGlmYWN0X1JlcG9Db2RlQ29tbWl0NzkxMEY1RjlcIixcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgIFwiT3V0cHV0QXJ0aWZhY3RzXCI6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICBcIk5hbWVcIjogXCJBcnRpZmFjdF9Qcm9qZWN0Q29kZUJ1aWxkRTM0QUQyRUNcIixcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfVxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxufTtcblxuZnVuY3Rpb24gYm91bmRzVmFsaWRhdGlvblJlc3VsdChudW1iZXJPZkFydGlmYWN0czogbnVtYmVyLCBtaW46IG51bWJlciwgbWF4OiBudW1iZXIpOiBzdHJpbmdbXSB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICBjb25zdCBwaXBlbGluZSA9IG5ldyBjb2RlcGlwZWxpbmUuUGlwZWxpbmUoc3RhY2ssICdwaXBlbGluZScpO1xuICBjb25zdCBzdGFnZSA9IG5ldyBjb2RlcGlwZWxpbmUuU3RhZ2Uoc3RhY2ssICdzdGFnZScsIHsgcGlwZWxpbmUgfSk7XG4gIGNvbnN0IGFjdGlvbiA9IG5ldyBUZXN0QWN0aW9uKHN0YWNrLCAnVGVzdEFjdGlvbicsIHtcbiAgICBzdGFnZSxcbiAgICBhcnRpZmFjdEJvdW5kczogYWN0aW9ucy5kZWZhdWx0Qm91bmRzKCksXG4gICAgY2F0ZWdvcnk6IGFjdGlvbnMuQWN0aW9uQ2F0ZWdvcnkuVGVzdCxcbiAgICBwcm92aWRlcjogJ3Rlc3QgcHJvdmlkZXInXG4gIH0pO1xuICBjb25zdCBhcnRpZmFjdHM6IGFjdGlvbnMuQXJ0aWZhY3RbXSA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mQXJ0aWZhY3RzOyBpKyspIHtcbiAgICBhcnRpZmFjdHMucHVzaChuZXcgYWN0aW9ucy5BcnRpZmFjdChhY3Rpb24sIGBUZXN0QXJ0aWZhY3Qke2l9YCkpO1xuICB9XG4gIHJldHVybiBhY3Rpb25zLnZhbGlkYXRlQXJ0aWZhY3RCb3VuZHMoJ291dHB1dCcsIGFydGlmYWN0cywgbWluLCBtYXgsICd0ZXN0Q2F0ZWdvcnknLCAndGVzdFByb3ZpZGVyJyk7XG59XG4iXX0=